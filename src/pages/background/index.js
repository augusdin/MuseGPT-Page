function E(t){let e,o,n,s,a,c,i;return y(),{feed:f,reset:y};function y(){e=!0,o="",n=0,s=-1,a=void 0,c=void 0,i=""}function f(d){o=o?o+d:d,e&&S(o)&&(o=o.slice(w.length)),e=!1;const l=o.length;let r=0,h=!1;for(;r<l;){h&&(o[r]===`
`&&++r,h=!1);let m=-1,u=s,p;for(let g=n;m<0&&g<l;++g)p=o[g],p===":"&&u<0?u=g-r:p==="\r"?(h=!0,m=g-r):p===`
`&&(m=g-r);if(m<0){n=l-r,s=u;break}else n=0,s=-1;I(o,r,u,m),r+=m+1}r===l?o="":r>0&&(o=o.slice(r))}function I(d,l,r,h){if(h===0){i.length>0&&(t({type:"event",id:a,event:c||void 0,data:i.slice(0,-1)}),i="",a=void 0),c=void 0;return}const m=r<0,u=d.slice(l,l+(m?h:r));let p=0;m?p=h:d[l+r+1]===" "?p=r+2:p=r+1;const g=l+p,P=h-p,b=d.slice(g,g+P).toString();if(u==="data")i+=b?"".concat(b,`
`):`
`;else if(u==="event")c=b;else if(u==="id"&&!b.includes("\0"))a=b;else if(u==="retry"){const x=parseInt(b,10);Number.isNaN(x)||t({type:"reconnect-interval",value:x})}}}const w=[239,187,191];function S(t){return w.every((e,o)=>t.charCodeAt(o)===e)}const C={openAIModel:"gpt-3.5-turbo-16k",openAITemperature:.5,isFollowSystemTheme:!0,userChosenTheme:"light"},v=(t,e,o)=>{if(e.status==="complete"){O(o);const n=document.getElementById("musegpt-tips");n&&n.remove(),chrome.tabs.onUpdated.removeListener(v)}},N=()=>{if(!document.getElementById("musegpt-tips")){const e=document.createElement("div");e.style.top="10px",e.style.right="10px",e.style.position="fixed",e.style.zIndex="9999",e.id="musegpt-tips",e.style.backgroundColor="rgba(0, 0, 0, 0.7)",e.style.color="white",e.style.borderRadius="10px",e.style.padding="10px",e.style.transition="opacity 0.3s",e.style.opacity="0",e.style.boxShadow="0 0 10px rgba(128, 128, 128, 0.5)",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center";const o=document.createElement("div");o.style.position="relative",o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="center",o.style.marginRight="10px";const n=document.createElement("span");n.style.display="inline-block",n.style.width="20px",n.style.height="20px",n.style.border="1px solid white",n.style.borderTopColor="transparent",n.style.borderRadius="50%",n.style.animation="spin 1s linear infinite";const s=document.createElement("span");s.style.display="inline-block",s.style.width="20px",s.style.height="20px",s.style.border="1px solid rgba(255, 255, 255, 0.3)",s.style.borderRadius="50%",s.style.position="absolute",o.appendChild(n),o.appendChild(s),e.appendChild(o);const a=document.createElement("span"),c=document.createTextNode("Waiting for the current page to finish loading...");a.appendChild(c),e.appendChild(a),document.body.appendChild(e);const i=document.createElement("style");i.textContent=`
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    `,document.head.appendChild(i),setTimeout(()=>{e.style.opacity="1"},50)}},O=async t=>{chrome.tabs.sendMessage(t.id,{message:"popup-active"},e=>{chrome.runtime.lastError?chrome.runtime.lastError.message:chrome.tabs.onUpdated.removeListener(v)})},k=async()=>{const{museOptions:t}=await chrome.storage.local.get(["museOptions"]),e=t;return e&&e.hasOwnProperty("openAIApiKey")&&e.openAIApiKey.trim()!==""?!0:(chrome.runtime.openOptionsPage(),!1)},M=async t=>{await k()&&(chrome.tabs.get(t.id,e=>{e.status,e.status==="loading"&&(chrome.tabs.onUpdated.addListener(v),chrome.scripting.executeScript({target:{tabId:t.id},func:N,injectImmediately:!0}))}),O(t))};chrome.action.onClicked.addListener(async t=>{M(t)});chrome.commands.onCommand.addListener(t=>{t==="_execute_action"&&chrome.tabs.query({active:!0,currentWindow:!0},e=>{const o=e[0];M(o)})});const A=()=>{chrome.tabs.query({},t=>{for(let e=0;e<t.length;e++)chrome.tabs.reload(t[e].id)})};chrome.runtime.onInstalled.addListener(t=>{t.reason=="update"&&A(),t.reason==="install"&&(k(),A())});let T;async function*L(t){const e=t.getReader();try{for(;;){const{done:o,value:n}=await e.read();if(o)return;yield n}}finally{e.releaseLock()}}const $=async(t,e)=>{const{onmessage:o,onerror:n}=e;if(!t.ok){n(t);return}const s=E(a=>{a.type==="event"&&o(a.data)});for await(const a of L(t.body)){const c=new TextDecoder().decode(a);s.feed(c)}},j=async(t,e)=>{T||(T=new AbortController);const{museOptions:o}=await chrome.storage.local.get(["museOptions"]);if(!o&&!o.openAIApiKey){t.postMessage({messageId:"error-fetch",errorContent:"fetch OpenAI API error: configuration uninitialized"}),console.error("fetch OpenAI API error: configuration uninitialized");return}const n=o,s=n.openAIModel||C.openAIModel,a=n.openAIApiKey,c=n.openAITemperature||C.openAITemperature;t.postMessage({messageId:"fetch-api-begin",options:{prompts:e,model:s,temperature:c}});const i=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({messages:e,model:`${s}`,temperature:c,stream:!0}),signal:T.signal});if(t.postMessage({messageId:"fetch-api-done",options:{prompts:e,model:s},apiResponse:i}),!i.ok)return console.error("error:fetch error,response:",i),t.postMessage({messageId:"error-fetch",errorContent:`fetch OpenAI API error,response:${i}`}),i;let y="";await $(i,{onmessage(f){if(f==="[DONE]")return t.postMessage({messageId:"onmessage-done",chatContent:y}),i;let I;try{I=JSON.parse(f)}catch(l){return console.error("parsing msg to JSON fail"),t.postMessage({messageId:"error-parsing-json",errorContent:`parsing msg to JSON fail,error: ${l}`}),i}let d;I.choices&&I.choices[0].delta&&(d=I.choices[0].delta.content),d&&(y+=d,t.postMessage({messageId:"onmessage-receving",chatContent:y}))},onerror(f){t.postMessage({messageId:"error-onstreaming",errorContent:`on streaming error: ${f}`}),console.error("on streaming error:",f)}})};chrome.runtime.onConnect.addListener(t=>{t.onMessage.addListener(e=>{if(e.task==="get-page-summary"){const o=e.prompts;j(t,o)}})});chrome.runtime.onMessage.addListener((t,e,o)=>{if(t.method==="open-option-page"&&(chrome.runtime.openOptionsPage(),o()),t.method==="abort-fetching-openai"&&(T.abort(),T=void 0,o()),t.method==="http-fetch-text")return fetch(t.url,t.options).then(async n=>{if(!n.ok)throw console.error("HTTP error in background:",n),new Error(`HTTP error! status: ${n.status}, statusText: ${n.statusText}`);return await n.text()}).then(n=>{o({data:n})}).catch(n=>{o({error:n.message})}),!0;if(t.method==="http-fetch")return fetch(t.url,t.options).then(n=>{if(!n.ok)throw console.error("HTTP error in background:",n),new Error(`HTTP error! status: ${n.status}, statusText: ${n.statusText}`);return n.json()}).then(n=>{o({data:n})}).catch(n=>o({error:n.message})),!0});
